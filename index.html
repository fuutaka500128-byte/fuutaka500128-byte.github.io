<script>
async function loadTimetable() {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, "0");
  const dd = String(today.getDate()).padStart(2, "0");

  const jsonPath = `timetable/${yyyy}${mm}${dd}.json`;

  let data;
  try {
    const res = await fetch(jsonPath);
    if (!res.ok) throw new Error();
    data = await res.json();
  } catch {
    console.error("ダイヤJSONが見つかりません:", jsonPath);
    return;
  }

  const track = document.getElementById("track");
  track.innerHTML = "";

  const now = new Date();
  const nowMinutes = now.getHours() * 60 + now.getMinutes();

  data.trains.forEach(train => {
    const [h, m] = train.time.split(":").map(Number);
    const trainMinutes = h * 60 + m;

    // 運休は時刻に関係なく表示
    if (train.status !== "cancel" && trainMinutes < nowMinutes) return;

    const item = document.createElement("div");
    item.className = "item";

    let statusText = "";
    let timeText = train.time;

    if (train.status === "delay") {
      statusText = `（遅延${train.delay}分）`;
      timeText = `${train.time}+${train.delay}`;
    }

    if (train.status === "cancel") {
      statusText = "（運休）";
    }

    item.innerHTML = `
      <span class="train ${train.service}">
        ${train.service}${train.number}
      </span>
      <span class="time">${timeText}</span>
      <span class="dest">${train.destination}${statusText}</span>
    `;

    track.appendChild(item);
  });
}

/* 初回読み込み */
loadTimetable();

/* ⏱ 1分ごとに自動更新 */
setInterval(loadTimetable, 60000);
</script>